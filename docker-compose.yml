version: '3.8'

services:
  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3-management
    container_name: secure-video-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"   # AMQP protocol
      - "15672:15672" # Management UI (User/Pass: guest/guest)
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    networks:
      - secure-video-network
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Email Worker (Consumer)
  email-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: secure-video-email-worker
    restart: unless-stopped
    command: ["node", "src/workers/emailWorker.js"]
    user: "1001:1001"
    read_only: true
    tmpfs:
      - /tmp
      - /app/tmp
    env_file:
      - ./BackEnd/.env
    environment:
      - NODE_ENV=production
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
    networks:
      - secure-video-network
    depends_on:
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./BackEnd/keys:/app/keys:ro
  transcode-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: secure-video-transcode-worker
    restart: unless-stopped
    command: ["node", "workers/transcodeWorker.js"]
    env_file:
      - ./BackEnd/.env  # <--- ชี้ไปที่ไฟล์ .env เพื่อให้ process.env มีค่า
    environment:
      - NODE_ENV=production
    networks:
      - secure-video-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    user: "1001:1001"
    read_only: true
    tmpfs:
      - /tmp
      - /app/tmp
  # React Frontend
  react-app:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./Frontvideo1:/app
      - /app/node_modules
    command: sh -c "npm install && npm run dev -- --host"
    ports:
      - "5173:5173"
    environment:
      - CHOKIDAR_USEPOLLING=true
      - HOST=0.0.0.0
    networks:
      - secure-video-network

  # Main Node.js API (Producer)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: secure-video-app
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:3000"
    env_file:
      - ./BackEnd/.env
    environment:
      - NODE_ENV=production
      - PORT=3000
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
    volumes:
      - ./BackEnd/keys:/app/keys:ro
      - ./BackEnd/vault/certs:/app/vault-certs:ro
      - app_logs:/app/logs
    networks:
      - secure-video-network
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy # เพิ่มเพื่อให้แน่ใจว่าส่งคิวได้ทันทีที่เริ่ม
    user: "1001:1001"
    read_only: true
    tmpfs:
      - /tmp
      - /app/tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: secure-video-mongodb
    restart: unless-stopped
    command: ["--replSet", "rs0", "--bind_ip_all"] 
    environment:
      MONGO_INITDB_DATABASE: secure-video
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./BackEnd/mongo-init:/docker-entrypoint-initdb.d
    networks:
      - secure-video-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"] # ปรับให้ simple ขึ้นถ้าไม่มี auth ในตัว
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis
  redis:
    image: redis:7.2-alpine
    container_name: secure-video-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - secure-video-network
    command: redis-server --appendonly yes --requirepass redispassword123
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx
  nginx:
    image: nginx:1.25-alpine
    container_name: secure-video-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./BackEnd/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./BackEnd/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./BackEnd/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - secure-video-network
    depends_on:
      - app

  # Monitoring Profiles
  prometheus:
    image: prom/prometheus:v2.47.0
    profiles: ["monitoring"]
    # ... (คงเดิมตามไฟล์เก่า)
    networks:
      - secure-video-network
  # Vault - production-ready
  # vault:
  #   image: vault:1.13.3
  #   container_name: secure-video-vault
  #   restart: unless-stopped
  #   ports:
  #     - "8200:8200"
  #   environment:
  #     VAULT_ADDR: https://0.0.0.0:8200
  #   cap_add:
  #     - IPC_LOCK
  #   networks:
  #     - secure-video-network
  #   volumes:
  #     - vault_data:/vault/data
  #     - ./vault/config:/vault/config:ro
  #     - ./vault/certs:/vault/certs:ro
  #   command: "vault server -config=/vault/config/server.hcl"
  #   healthcheck:
  #     test: ["CMD", "vault", "status", "-address=https://0.0.0.0:8200"]
  #     interval: 10s
  #     retries: 5
networks:
  secure-video-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data: # เพิ่ม volume สำหรับ rabbitmq
  app_logs:
  nginx_logs:
  prometheus_data:
  grafana_data: