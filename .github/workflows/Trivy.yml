name: Security Scan with Summary

on:
  push:
    branches: [main, Feather]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  security-scan:
    name: üîí Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ============================================
      # 1Ô∏è‚É£ BUILD DOCKER IMAGE
      # ============================================
      - name: üèóÔ∏è Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: myapp:${{ github.sha }},myapp:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================================
      # 2Ô∏è‚É£ TRIVY SCANS (Quality Gate)
      # ============================================
      - name: üîç Trivy - Filesystem Scan (Quality Gate)
        id: trivy-fs-gate
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on CRITICAL/HIGH
          ignore-unfixed: true
          format: 'json'
          output: 'trivy-fs-gate.json'

      - name: üê≥ Trivy - Docker Image Scan (Quality Gate)
        id: trivy-docker-gate
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'myapp:latest'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on CRITICAL/HIGH
          ignore-unfixed: true
          format: 'json'
          output: 'trivy-docker-gate.json'

      - name: ‚öôÔ∏è Trivy - Config Scan (Quality Gate)
        id: trivy-config-gate
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on config issues (warning only)
          format: 'json'
          output: 'trivy-config-gate.json'

      # ============================================
      # 3Ô∏è‚É£ DETAILED REPORTS (All Severities)
      # ============================================
      - name: üìä Trivy - Full Filesystem Report
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'

      - name: üìä Trivy - Full Docker Report
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'myapp:latest'
          format: 'sarif'
          output: 'trivy-docker-results.sarif'

      - name: üìä Trivy - Full Config Report
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config-results.sarif'

      # ============================================
      # 4Ô∏è‚É£ GENERATE SUMMARY
      # ============================================
      - name: üìù Generate Security Summary
        if: always()
        run: |
          echo "# üîí Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to count vulnerabilities
          count_vulns() {
            local file=$1
            if [ -f "$file" ]; then
              CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$file" 2>/dev/null || echo "0")
              HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$file" 2>/dev/null || echo "0")
              MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$file" 2>/dev/null || echo "0")
              LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' "$file" 2>/dev/null || echo "0")
              echo "$CRITICAL|$HIGH|$MEDIUM|$LOW"
            else
              echo "0|0|0|0"
            fi
          }

          # Filesystem Scan
          echo "## üìÅ Filesystem Scan" >> $GITHUB_STEP_SUMMARY
          FS_COUNTS=$(count_vulns "trivy-fs-gate.json")
          FS_CRIT=$(echo $FS_COUNTS | cut -d'|' -f1)
          FS_HIGH=$(echo $FS_COUNTS | cut -d'|' -f2)
          FS_MED=$(echo $FS_COUNTS | cut -d'|' -f3)
          FS_LOW=$(echo $FS_COUNTS | cut -d'|' -f4)
          
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ Critical | $FS_CRIT |" >> $GITHUB_STEP_SUMMARY
          echo "| üü† High | $FS_HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° Medium | $FS_MED |" >> $GITHUB_STEP_SUMMARY
          echo "| üü¢ Low | $FS_LOW |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Docker Scan
          echo "## üê≥ Docker Image Scan" >> $GITHUB_STEP_SUMMARY
          DOCKER_COUNTS=$(count_vulns "trivy-docker-gate.json")
          DOCKER_CRIT=$(echo $DOCKER_COUNTS | cut -d'|' -f1)
          DOCKER_HIGH=$(echo $DOCKER_COUNTS | cut -d'|' -f2)
          DOCKER_MED=$(echo $DOCKER_COUNTS | cut -d'|' -f3)
          DOCKER_LOW=$(echo $DOCKER_COUNTS | cut -d'|' -f4)
          
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ Critical | $DOCKER_CRIT |" >> $GITHUB_STEP_SUMMARY
          echo "| üü† High | $DOCKER_HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° Medium | $DOCKER_MED |" >> $GITHUB_STEP_SUMMARY
          echo "| üü¢ Low | $DOCKER_LOW |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Total Summary
          TOTAL_CRIT=$((FS_CRIT + DOCKER_CRIT))
          TOTAL_HIGH=$((FS_HIGH + DOCKER_HIGH))
          
          echo "## üìä Overall Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $TOTAL_CRIT -gt 0 ] || [ $TOTAL_HIGH -gt 0 ]; then
            echo "‚ùå **FAILED** - Found $TOTAL_CRIT critical and $TOTAL_HIGH high severity issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **PASSED** - No critical or high severity issues found" >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # 5Ô∏è‚É£ UPLOAD REPORTS
      # ============================================
      - name: üì§ Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: '.'
          category: trivy-security-scan

      - name: üì¶ Upload Trivy Reports as Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports-${{ github.sha }}
          path: |
            trivy-*.json
            trivy-*.sarif
          retention-days: 30

      # ============================================
      # 6Ô∏è‚É£ SLACK NOTIFICATION
      # ============================================
      - name: üì¢ Slack Notification
        if: always() && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Security Scan ${{ job.status }}
            Repo: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}