name: Security Scan (Fixed) Trivy

on:
  push:
    branches: [main, Feather]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  security-scan:
    name: ðŸ”’ Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ============================================
      # BUILD
      # ============================================
      - name: ðŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: myapp:${{ github.sha }},myapp:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================================
      # SCAN 1: Filesystem (à¹à¸¢à¸ category)
      # ============================================
      - name: ðŸ” Trivy - Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH,MEDIUM'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'

      - name: ðŸ“¤ Upload Filesystem SARIF
        uses: github/codeql-action/upload-sarif@v4  # âœ… à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™ v4
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'  # âœ… category à¹à¸¢à¸à¸•à¹ˆà¸²à¸‡à¸«à¸²à¸

      # ============================================
      # SCAN 2: Docker Image (à¹à¸¢à¸ category)
      # ============================================
      - name: ðŸ³ Trivy - Docker Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'myapp:latest'
          severity: 'CRITICAL,HIGH,MEDIUM'
          format: 'sarif'
          output: 'trivy-docker-results.sarif'

      - name: ðŸ“¤ Upload Docker SARIF
        uses: github/codeql-action/upload-sarif@v4  # âœ… à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™ v4
        if: always()
        with:
          sarif_file: 'trivy-docker-results.sarif'
          category: 'trivy-docker'  # âœ… category à¹à¸¢à¸à¸•à¹ˆà¸²à¸‡à¸«à¸²à¸

      # ============================================
      # SCAN 3: IaC/Config (à¹à¸¢à¸ category)
      # ============================================
      - name: âš™ï¸ Trivy - Config Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH,MEDIUM'
          format: 'sarif'
          output: 'trivy-config-results.sarif'

      - name: ðŸ“¤ Upload Config SARIF
        uses: github/codeql-action/upload-sarif@v4  # âœ… à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™ v4
        if: always()
        with:
          sarif_file: 'trivy-config-results.sarif'
          category: 'trivy-config'  # âœ… category à¹à¸¢à¸à¸•à¹ˆà¸²à¸‡à¸«à¸²à¸

      # ============================================
      # QUALITY GATE (à¹ƒà¸Šà¹‰ JSON à¹à¸—à¸™ SARIF)
      # ============================================
      - name: ðŸš¨ Trivy Quality Gate
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'myapp:latest'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on CRITICAL/HIGH
          ignore-unfixed: true
          format: 'json'
          output: 'trivy-results.json'

      # ============================================
      # GENERATE SUMMARY
      # ============================================
      - name: ðŸ“ Generate Security Summary
        if: always()
        run: |
          echo "# ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to count vulnerabilities
          count_vulns() {
            local file=$1
            if [ -f "$file" ]; then
              CRITICAL=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$file" 2>/dev/null || echo "0")
              HIGH=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$file" 2>/dev/null || echo "0")
              MEDIUM=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$file" 2>/dev/null || echo "0")
              LOW=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' "$file" 2>/dev/null || echo "0")
              echo "$CRITICAL|$HIGH|$MEDIUM|$LOW"
            else
              echo "0|0|0|0"
            fi
          }

          # Parse results
          if [ -f "trivy-results.json" ]; then
            COUNTS=$(count_vulns "trivy-results.json")
            CRIT=$(echo $COUNTS | cut -d'|' -f1)
            HIGH=$(echo $COUNTS | cut -d'|' -f2)
            MED=$(echo $COUNTS | cut -d'|' -f3)
            LOW=$(echo $COUNTS | cut -d'|' -f4)
            
            echo "## ðŸ“Š Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRIT | $([ $CRIT -gt 0 ] && echo 'âŒ' || echo 'âœ…') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH | $([ $HIGH -gt 0 ] && echo 'âš ï¸' || echo 'âœ…') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Medium | $MED | $([ $MED -gt 0 ] && echo 'âš ï¸' || echo 'âœ…') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ Low | $LOW | â„¹ï¸ |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            TOTAL=$((CRIT + HIGH))
            if [ $TOTAL -gt 0 ]; then
              echo "## âŒ Quality Gate: FAILED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Found **$CRIT critical** and **$HIGH high** severity vulnerabilities." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ”§ Top Vulnerabilities:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH") | "- **\(.VulnerabilityID)** (\(.Severity)): \(.Title) in \(.PkgName)"' trivy-results.json | head -10 >> $GITHUB_STEP_SUMMARY || true
            else
              echo "## âœ… Quality Gate: PASSED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "No critical or high severity vulnerabilities found! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      # ============================================
      # UPLOAD ARTIFACTS
      # ============================================
      - name: ðŸ“¦ Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports-${{ github.sha }}
          path: |
            trivy-*.json
            trivy-*.sarif
          retention-days: 30

      # ============================================
      # SLACK NOTIFICATION (Optional)
      # ============================================
      - name: ðŸ“¢ Slack Notification
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: 'failure'
          text: |
            ðŸš¨ Security Scan Failed!
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            
            View Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          fields: repo,message,commit,author
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
# ============================================
      # GENERATE SUMMARY
      # ============================================
      - name: ðŸ“ Generate Security Summary
        if: always()
        run: |
          echo "# ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to count vulnerabilities
          count_vulns() {
            local file=$1
            if [ -f "$file" ]; then
              CRITICAL=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$file" 2>/dev/null || echo "0")
              HIGH=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$file" 2>/dev/null || echo "0")
              MEDIUM=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$file" 2>/dev/null || echo "0")
              LOW=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' "$file" 2>/dev/null || echo "0")
              echo "$CRITICAL|$HIGH|$MEDIUM|$LOW"
            else
              echo "0|0|0|0"
            fi
          }

          # Parse results
          if [ -f "trivy-results.json" ]; then
            COUNTS=$(count_vulns "trivy-results.json")
            CRIT=$(echo $COUNTS | cut -d'|' -f1)
            HIGH=$(echo $COUNTS | cut -d'|' -f2)
            MED=$(echo $COUNTS | cut -d'|' -f3)
            LOW=$(echo $COUNTS | cut -d'|' -f4)
            
            echo "## ðŸ“Š Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRIT | $([ $CRIT -gt 0 ] && echo 'âŒ' || echo 'âœ…') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH | $([ $HIGH -gt 0 ] && echo 'âš ï¸' || echo 'âœ…') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Medium | $MED | $([ $MED -gt 0 ] && echo 'âš ï¸' || echo 'âœ…') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ Low | $LOW | â„¹ï¸ |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            TOTAL=$((CRIT + HIGH))
            if [ $TOTAL -gt 0 ]; then
              echo "## âŒ Quality Gate: FAILED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Found **$CRIT critical** and **$HIGH high** severity vulnerabilities." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸Šà¹ˆà¸­à¸‡à¹‚à¸«à¸§à¹ˆà¸—à¸µà¹ˆà¸žà¸š
              echo "### ðŸ” Vulnerability Details" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Critical vulnerabilities
              if [ $CRIT -gt 0 ]; then
                echo "#### ðŸ”´ Critical Vulnerabilities" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | "**\(.VulnerabilityID)** - \(.Title)\n- **Package:** \(.PkgName) \(.InstalledVersion)\n- **Fixed Version:** \(.FixedVersion // "N/A")\n- **CVSS Score:** \(.CVSS.nvd.V3Score // .CVSS.redhat.V3Score // "N/A")\n- **Description:** \(.Description)\n- **References:** \(.PrimaryURL)\n"' trivy-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              # High vulnerabilities
              if [ $HIGH -gt 0 ]; then
                echo "#### ðŸŸ  High Vulnerabilities" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH") | "**\(.VulnerabilityID)** - \(.Title)\n- **Package:** \(.PkgName) \(.InstalledVersion)\n- **Fixed Version:** \(.FixedVersion // "N/A")\n- **CVSS Score:** \(.CVSS.nvd.V3Score // .CVSS.redhat.V3Score // "N/A")\n- **Description:** \(.Description)\n- **References:** \(.PrimaryURL)\n"' trivy-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "---" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ **Remediation Steps:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Review the vulnerabilities listed above" >> $GITHUB_STEP_SUMMARY
              echo "2. Update affected packages to fixed versions" >> $GITHUB_STEP_SUMMARY
              echo "3. Run security scan again to verify fixes" >> $GITHUB_STEP_SUMMARY
              echo "4. Check the full report in artifacts for more details" >> $GITHUB_STEP_SUMMARY
            else
              echo "## âœ… Quality Gate: PASSED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "No critical or high severity vulnerabilities found! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
            fi
          fi