name: Full Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
    
      # 1. üîç Scan source code
      - name: Scan source code (filesystem)
        run: |
          trivy fs --format json --output trivy-fs.json --severity HIGH,CRITICAL . || true
          trivy fs --format table --output trivy-fs-table.txt --severity HIGH,CRITICAL . || true

      # 2. üê≥ Scan Docker image
      - name: Scan Docker image
        run: |
          docker build -t myapp:latest .
          trivy image --format json --output trivy-docker.json --severity HIGH,CRITICAL myapp:latest || true
          trivy image --format table --output trivy-docker-table.txt --severity HIGH,CRITICAL myapp:latest || true

      # 3. ‚öôÔ∏è Scan IaC
      - name: Scan IaC (Terraform / K8s)
        run: |
          trivy config --format json --output trivy-iac.json --severity HIGH,CRITICAL . || true
          trivy config --format table --output trivy-iac-table.txt --severity HIGH,CRITICAL . || true

      # 4. üìä Generate HTML Reports
      - name: Generate HTML Reports
        run: |
          # Convert JSON to HTML using trivy convert
          trivy convert --format template --template "@contrib/html.tpl" --input trivy-fs.json --output trivy-fs.html || true
          trivy convert --format template --template "@contrib/html.tpl" --input trivy-docker.json --output trivy-docker.html || true
          trivy convert --format template --template "@contrib/html.tpl" --input trivy-iac.json --output trivy-iac.html || true

      # 5. üìù Create Combined Summary
      - name: Create Combined Summary Report
        run: |
          cat > trivy-combined-summary.md << 'EOF'
          # üîí Security Scan Summary
          
          ## üìÅ Filesystem Scan
          EOF
          cat trivy-fs-table.txt >> trivy-combined-summary.md || echo "No filesystem vulnerabilities" >> trivy-combined-summary.md
          
          cat >> trivy-combined-summary.md << 'EOF'
          
          ## üê≥ Docker Image Scan
          EOF
          cat trivy-docker-table.txt >> trivy-combined-summary.md || echo "No Docker vulnerabilities" >> trivy-combined-summary.md
          
          cat >> trivy-combined-summary.md << 'EOF'
          
          ## ‚öôÔ∏è IaC Scan
          EOF
          cat trivy-iac-table.txt >> trivy-combined-summary.md || echo "No IaC vulnerabilities" >> trivy-combined-summary.md

      # 6. üìä Count Vulnerabilities
      - name: Count Vulnerabilities
        id: count_vulns
        run: |
          FS_COUNT=$(grep -c '"Severity": "CRITICAL"\|"Severity": "HIGH"' trivy-fs.json || echo "0")
          DOCKER_COUNT=$(grep -c '"Severity": "CRITICAL"\|"Severity": "HIGH"' trivy-docker.json || echo "0")
          IAC_COUNT=$(grep -c '"Severity": "CRITICAL"\|"Severity": "HIGH"' trivy-iac.json || echo "0")
          TOTAL=$((FS_COUNT + DOCKER_COUNT + IAC_COUNT))
          
          echo "fs_count=$FS_COUNT" >> $GITHUB_OUTPUT
          echo "docker_count=$DOCKER_COUNT" >> $GITHUB_OUTPUT
          echo "iac_count=$IAC_COUNT" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      # 7. üì§ Upload Reports
      - name: Upload Reports as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            trivy-fs.json
            trivy-fs.html
            trivy-fs-table.txt
            trivy-docker.json
            trivy-docker.html
            trivy-docker-table.txt
            trivy-iac.json
            trivy-iac.html
            trivy-iac-table.txt
            trivy-combined-summary.md

      # 8. üì¢ Send Slack Notification
      - name: Send Slack Notification
        if: always()
        run: |
          TOTAL_VULNS="${{ steps.count_vulns.outputs.total }}"
          FS_VULNS="${{ steps.count_vulns.outputs.fs_count }}"
          DOCKER_VULNS="${{ steps.count_vulns.outputs.docker_count }}"
          IAC_VULNS="${{ steps.count_vulns.outputs.iac_count }}"
          
          if [ "$TOTAL_VULNS" -eq "0" ]; then
            STATUS="‚úÖ Security Scan Passed"
            COLOR="good"
          else
            STATUS="‚ö†Ô∏è Vulnerabilities Found!"
            COLOR="warning"
          fi
          
          # Get summary (first 20 lines)
          SUMMARY=$(head -n 20 trivy-combined-summary.md | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          
          curl -X POST -H "Content-type: application/json" \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$STATUS\",
                \"fields\": [
                  {\"title\": \"Total Vulnerabilities\", \"value\": \"$TOTAL_VULNS\", \"short\": true},
                  {\"title\": \"Filesystem\", \"value\": \"$FS_VULNS\", \"short\": true},
                  {\"title\": \"Docker Image\", \"value\": \"$DOCKER_VULNS\", \"short\": true},
                  {\"title\": \"IaC\", \"value\": \"$IAC_VULNS\", \"short\": true}
                ],
                \"text\": \"View detailed reports in GitHub Actions Artifacts\"
              }]
            }" \
            $SLACK_WEBHOOK_URL