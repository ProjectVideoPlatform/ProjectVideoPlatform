name: Full Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy (Official Repository)
        # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Trivy CLI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á trivy ‡πÑ‡∏î‡πâ
        run: |
          # ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Trivy ‡πÄ‡∏î‡∏¥‡∏°)
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
    
      # 1. üîç Scan source code (filesystem) - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡πà JSON Output
      - name: Scan source code (filesystem)
        run: |
          trivy fs --format json --output trivy-fs.json --severity HIGH,CRITICAL . || true

      # 2. üê≥ Scan Docker image - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡πà JSON Output
      - name: Scan Docker image
        run: |
          docker build -t myapp:latest .
          trivy image --format json --output trivy-docker.json --severity HIGH,CRITICAL myapp:latest || true

      # 3. ‚öôÔ∏è Scan IaC (Terraform / K8s) - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡πà JSON Output
      - name: Scan IaC (Terraform / K8s)
        run: |
          trivy config --format json --output trivy-iac.json --severity HIGH,CRITICAL . || true

      # üí° ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏£‡∏ß‡∏° JSON ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ Markdown/HTML
      - name: Combine JSON Reports and Generate Summary (Markdown/Table)
        # ‡πÉ‡∏ä‡πâ Trivy Action ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå JSON ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ
        uses: aquasecurity/trivy-action@master
        with:
          # ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ü‡∏•‡πå JSON ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
          input: 'trivy-fs.json,trivy-docker.json,trivy-iac.json'
          format: 'table' # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á Markdown
          output: 'trivy-combined-summary.md'
          # *‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ template ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ format: 'table'*
          
      - name: Generate HTML Reports from JSON
        # ‡πÉ‡∏ä‡πâ 'trivy post' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á JSON ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô HTML ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°
        run: |
          # File System Report
          trivy post --format template --template "@contrib/html.tpl" --input trivy-fs.json --output trivy-fs.html || true
          
          # Docker Image Report
          trivy post --format template --template "@contrib/html.tpl" --input trivy-docker.json --output trivy-docker.html || true
          
          # IaC Report
          trivy post --format template --template "@contrib/html.tpl" --input trivy-iac.json --output trivy-iac.html || true

      - name: Upload Reports as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            trivy-fs.json
            trivy-fs.html
            trivy-docker.json
            trivy-docker.html
            trivy-iac.json
            trivy-iac.html
            trivy-combined-summary.md # üìå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏£‡∏∏‡∏õ Markdown

      - name: Send Slack Notification
        if: always()
        run: |
          STATUS="‚úÖ Security Scan Passed"
          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡πÉ‡∏ô JSON outputs ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if grep -q '"VulnerabilityID":' trivy-fs.json trivy-docker.json trivy-iac.json; then
            STATUS="‚ö†Ô∏è Vulnerabilities Found! Check reports."
          fi
          
          # üí° ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏î‡∏∂‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Markdown ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô Slack Message (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô)
          SUMMARY=$(cat trivy-combined-summary.md | head -n 5)
          
          curl -X POST -H "Content-type: application/json" \
            --data "{
              \"text\": \"[Security Scan] $STATUS\",
              \"blocks\": [
                {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"*Security Scan Result:* $STATUS\"}},
                {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"_Artifacts available in GitHub Actions. | *Summary:*\\n$SUMMARY\"}}
              ]
            }" \
            $SLACK_WEBHOOK_URL